<!doctype html><meta charset="utf-8"><title>MedBot WebChat</title>
<style>
body{margin:0;background:#f7f7f8;font:16px system-ui}
.wrap{max-width:760px;margin:0 auto;padding:16px 16px 120px}
.b{background:#fff;border-radius:20px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin:10px 0;white-space:pre-wrap;line-height:1.45}
.me{background:#eaf3ff}
.form{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;padding:10px}
.row{max-width:760px;margin:0 auto;display:flex;gap:8px;align-items:center}
input[type=text]{flex:1;padding:12px;border:1px solid #ddd;border-radius:12px}
button{padding:12px 16px;border:0;border-radius:12px;background:#111;color:#fff}
.muted{opacity:.65}
</style>
<div class="wrap" id="msgs"></div>
<div class="form">
  <form id="f" class="row">
    <input id="q" type="text" placeholder="Напишите ответ..." autocomplete="off">
    <button id="sendBtn">Отправить</button>
  </form>
</div>
<script>
const API="/api/chat";
const msgs=document.getElementById('msgs');
const form=document.getElementById('f');
const q=document.getElementById('q');
const sendBtn=document.getElementById('sendBtn');
let sid=null;

function add(text,me=false,cls=''){
  const d=document.createElement('div');
  d.className='b'+(me?' me':'')+(cls?(' '+cls):'');
  d.textContent=text;
  msgs.appendChild(d);
  window.scrollTo(0,document.body.scrollHeight);
  return d;
}

function setDisabled(dis){
  q.disabled=dis; sendBtn.disabled=dis;
  if(dis){ sendBtn.classList.add('muted'); } else { sendBtn.classList.remove('muted'); }
}

function showTyping(){
  let dots=0;
  const el=add('Печатаю',false,'muted');
  const id=setInterval(()=>{ dots=(dots+1)%4; el.textContent='Печатаю'+'.'.repeat(dots); },300);
  return ()=>{ clearInterval(id); el.remove(); };
}

async function callApi(payload){
  const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function sendMessage(text){
  const body = sid? {session_id:sid,message:text}:{message:text};
  setDisabled(true);
  const stopTyping=showTyping();
  try{
    const j = await callApi(body);
    if(!sid) sid=j.session_id;
    stopTyping();
    setDisabled(false);
    return j;
  }catch(e){
    stopTyping();
    setDisabled(false);
    throw e;
  }
}

// автостарт — получить первый вопрос
(async()=>{
  try{
    const j = await sendMessage("");
    add(j.reply);
  }catch(e){
    add('Ошибка сети. Обновите страницу и попробуйте снова.');
  }
})();

// отправка текста
form.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const t=q.value.trim();
  if(!t) return;
  q.value='';
  add(t,true);
  try{
    const j = await sendMessage(t);
    add(j.reply);
    if(j.done){ sid=null; }
  }catch(e){
    add('Ошибка сети. Попробуйте ещё раз.', false, 'muted');
  }
});
</script>
